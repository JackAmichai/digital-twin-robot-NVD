#!/usr/bin/env python3
"""
Generate a simple warehouse map PGM file for Nav2.

This creates a basic warehouse layout matching our zone definitions:
- Loading dock (5.0, 2.0)
- Storage (-5.0, 2.0)
- Assembly (0.0, 5.0)
- Charging (0.0, -5.0)
- Inspection (3.0, 0.0)

Map is 400x400 pixels at 0.05m/pixel = 20m x 20m
Origin at center: (-10, -10)
"""

import numpy as np


def create_warehouse_map():
    """Create warehouse occupancy grid."""
    # Map size: 400x400 pixels, 0.05m resolution = 20m x 20m
    width = 400
    height = 400
    resolution = 0.05
    
    # Initialize map (254 = free space)
    map_data = np.full((height, width), 254, dtype=np.uint8)
    
    def world_to_pixel(x, y):
        """Convert world coordinates to pixel coordinates."""
        px = int((x + 10.0) / resolution)
        py = int((y + 10.0) / resolution)
        return px, py
    
    def draw_wall(x1, y1, x2, y2, thickness=2):
        """Draw a wall (0 = occupied)."""
        px1, py1 = world_to_pixel(x1, y1)
        px2, py2 = world_to_pixel(x2, y2)
        
        # Bresenham-like thick line
        dx = abs(px2 - px1)
        dy = abs(py2 - py1)
        
        if dx > dy:
            for i in range(min(px1, px2), max(px1, px2) + 1):
                t = (i - px1) / (px2 - px1) if px2 != px1 else 0
                j = int(py1 + t * (py2 - py1))
                for k in range(-thickness, thickness + 1):
                    if 0 <= i < width and 0 <= j + k < height:
                        map_data[j + k, i] = 0
        else:
            for j in range(min(py1, py2), max(py1, py2) + 1):
                t = (j - py1) / (py2 - py1) if py2 != py1 else 0
                i = int(px1 + t * (px2 - px1))
                for k in range(-thickness, thickness + 1):
                    if 0 <= i + k < width and 0 <= j < height:
                        map_data[j, i + k] = 0
    
    def draw_rect(x, y, w, h):
        """Draw a rectangular obstacle."""
        px, py = world_to_pixel(x, y)
        pw = int(w / resolution)
        ph = int(h / resolution)
        
        for i in range(px, px + pw):
            for j in range(py, py + ph):
                if 0 <= i < width and 0 <= j < height:
                    map_data[j, i] = 0
    
    # Outer walls
    draw_wall(-9.5, -9.5, 9.5, -9.5, 3)   # Bottom
    draw_wall(-9.5, 9.5, 9.5, 9.5, 3)     # Top
    draw_wall(-9.5, -9.5, -9.5, 9.5, 3)   # Left
    draw_wall(9.5, -9.5, 9.5, 9.5, 3)     # Right
    
    # Storage shelves (left side, around storage zone)
    draw_rect(-8.0, 0.0, 1.5, 3.0)
    draw_rect(-8.0, 4.0, 1.5, 3.0)
    draw_rect(-6.0, 0.0, 0.5, 2.5)
    draw_rect(-6.0, 3.5, 0.5, 2.5)
    
    # Loading dock barriers (right side)
    draw_rect(6.5, 0.5, 2.5, 0.5)
    draw_rect(6.5, 3.0, 2.5, 0.5)
    
    # Assembly area equipment (top center)
    draw_rect(-2.0, 6.5, 1.0, 1.5)
    draw_rect(1.0, 6.5, 1.0, 1.5)
    draw_rect(-0.5, 7.5, 1.0, 1.0)
    
    # Charging station enclosure (bottom center)
    draw_rect(-1.5, -8.5, 3.0, 0.5)
    draw_rect(-1.5, -8.5, 0.5, 2.0)
    draw_rect(1.0, -8.5, 0.5, 2.0)
    
    # Inspection station table
    draw_rect(2.0, -1.0, 2.0, 2.0)
    
    # Center pillars
    draw_rect(-3.0, -1.0, 0.8, 0.8)
    draw_rect(4.0, 3.0, 0.8, 0.8)
    
    # Internal divider wall
    draw_wall(-4.0, -2.0, -4.0, -6.0, 2)
    
    return map_data


def save_pgm(filename, data):
    """Save map as PGM file."""
    height, width = data.shape
    
    with open(filename, 'wb') as f:
        # PGM header
        f.write(f'P5\n'.encode())
        f.write(f'# Warehouse map for Digital Twin Robotics Lab\n'.encode())
        f.write(f'{width} {height}\n'.encode())
        f.write(f'255\n'.encode())
        
        # Write pixel data
        f.write(data.tobytes())
    
    print(f"Saved map to {filename}")
    print(f"  Size: {width}x{height} pixels")
    print(f"  Resolution: 0.05 m/pixel")
    print(f"  World size: 20x20 meters")


def main():
    """Generate and save warehouse map."""
    print("Generating warehouse map...")
    
    map_data = create_warehouse_map()
    save_pgm("maps/warehouse.pgm", map_data)
    
    # Print zone locations for reference
    zones = {
        "Loading Dock": (5.0, 2.0),
        "Storage": (-5.0, 2.0),
        "Assembly": (0.0, 5.0),
        "Charging": (0.0, -5.0),
        "Inspection": (3.0, 0.0),
    }
    
    print("\nZone locations (world coordinates):")
    for name, (x, y) in zones.items():
        print(f"  {name}: ({x}, {y})")


if __name__ == "__main__":
    main()
